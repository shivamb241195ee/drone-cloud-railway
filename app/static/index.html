<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Drone Cloud - Dashboard</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:16px}
    h1{font-size:1.2rem}
    .card{border:1px solid #ddd;padding:12px;border-radius:8px;max-width:720px}
    .grid{display:flex;gap:12px}
    .telemetry{flex:1}
    .photos{width:320px}
    img.thumb{max-width:100%;height:auto;border-radius:6px;margin-bottom:8px}
    .mono{font-family:monospace}
    .status{font-size:0.9rem;color:green}
  </style>
</head>
<body>
  <h1>Drone Cloud — Dashboard</h1>
  <div class="card">
    <div>
      <label>WebSocket token: <input id="token" value="change-this-secret" style="width:260px"/></label>
      <button id="connect">Connect WS</button>
      <span id="ws-status" class="status">disconnected</span>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="telemetry">
        <h2>Latest telemetry</h2>
        <div id="latest" class="mono">No data yet.</div>
        <button id="fetch-recent">Fetch recent (10)</button>
        <pre id="recent" style="max-height:200px;overflow:auto;background:#f8f8f8;padding:8px;border-radius:6px;">[]</pre>
      </div>

      <div class="photos">
        <h2>Photos</h2>
        <div id="photos-list">No photos yet.</div>
      </div>
    </div>
  </div>

  <script>
    let ws;
    const statusEl = document.getElementById('ws-status');
    const latestEl = document.getElementById('latest');
    const photosList = document.getElementById('photos-list');
    const recentPre = document.getElementById('recent');

    document.getElementById('connect').addEventListener('click', ()=>{
      const token = document.getElementById('token').value;
      if (ws) ws.close();
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const url = `${proto}://${location.host}/ws?token=${encodeURIComponent(token)}`;
      ws = new WebSocket(url);
      statusEl.textContent = 'connecting...';

      ws.onopen = ()=>{ statusEl.textContent = 'connected'; };
      ws.onclose = ()=>{ statusEl.textContent = 'disconnected'; };
      ws.onerror = (e)=>{ statusEl.textContent = 'error'; console.error(e); };

      ws.onmessage = (ev)=>{
        const txt = ev.data;
        try{
          if (txt.startsWith('PHOTO:')){
            const url = txt.slice(6);
            addPhoto(url);
            return;
          }
          const obj = JSON.parse(txt);
          if (obj && obj.type === 'telemetry' && obj.data){
            showLatest(obj.data);
            return;
          }
        }catch(e){
          console.log('ws msg', txt);
        }
      };
    });

    function showLatest(d){
      latestEl.textContent = JSON.stringify(d, null, 2);
    }

    function addPhoto(url){
      const a = document.createElement('a');
      a.href = url;
      a.target = '_blank';
      const img = document.createElement('img');
      img.src = url;
      img.className = 'thumb';
      a.appendChild(img);
      photosList.insertBefore(a, photosList.firstChild);
    }

    document.getElementById('fetch-recent').addEventListener('click', async ()=>{
  const btn = document.getElementById('fetch-recent');
  const recentPre = document.getElementById('recent');
  const orig = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Loading…';
  try {
    const res = await fetch('/api/telemetry/recent?limit=10', { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const j = await res.json();
    recentPre.textContent = JSON.stringify(j.rows || [], null, 2);
  } catch (err) {
    recentPre.textContent = `fetch failed: ${err}`;
    console.error('fetch recent error', err);
  } finally {
    btn.disabled = false;
    btn.textContent = orig;
  }
});

  </script>
</body>
</html>
