<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Drone Cloud Dashboard</title>
  <style>
    body{font-family:Inter,system-ui,Arial;margin:18px}
    button{padding:10px 12px;margin:6px}
    #snap { width:640px; height:480px; background:#000; display:block; }
    #telemetry { margin-top:10px; }
    .log { font-family:monospace; white-space:pre-wrap; background:#f4f4f4;padding:8px;border-radius:6px; max-width:720px }
  </style>
</head>
<body>
  <h2>Drone Cloud Dashboard</h2>
  <p>WS / REST endpoints: <code>/ws</code> & <code>/api/*</code></p>

  <img id="snap" alt="latest snapshot">
  <div>
    <button onclick="send('TAKEOFF')">TAKEOFF</button>
    <button onclick="send('LAND')">LAND</button>
    <button onclick="send('UP')">UP</button>
    <button onclick="send('DOWN')">DOWN</button>
    <button onclick="send('LEFT')">LEFT</button>
    <button onclick="send('RIGHT')">RIGHT</button>
    <button onclick="send('CAPTURE')">REQUEST PHOTO</button>
    <button onclick="send('LED_ON')">LED ON</button>
    <button onclick="send('LED_OFF')">LED OFF</button>
  </div>

  <div style="margin-top:8px">
    <input id="say" style="width:380px;padding:8px" placeholder="Text to speak on drone">
    <button onclick="send('SPEAK:'+document.getElementById('say').value)">SPEAK</button>
  </div>

  <h3>Telemetry</h3>
  <div id="telemetry" class="log">No data yet</div>

  <h3>Messages</h3>
  <div id="msgs" class="log">No messages yet</div>

<script>
const AUTH = 'change-this-secret'; // replace with actual token or set via server-side templating
const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws?token=' + AUTH;
let ws = null;

function initWS(){
  ws = new WebSocket(WS_URL);
  ws.onopen = ()=> appendMsg('WS connected');
  ws.onmessage = (e) => {
    appendMsg('WS <- ' + e.data);
    if(e.data.startsWith('PHOTO:')){
      const url = e.data.replace('PHOTO:','');
      // If Cloudinary / HTTPS URL
      if(url.startsWith('http')){
        document.getElementById('snap').src = url;
      } else {
        // local path fallback - show text
        document.getElementById('snap').src = '';
        appendMsg('Photo saved at (server): ' + url);
      }
    } else if(e.data.startsWith('PHOTO:LOCAL:')){
      appendMsg('Local photo stored: ' + e.data);
    } else {
      try {
        const j = JSON.parse(e.data);
        if(j.type === 'telemetry') {
          showTelemetry(j.data);
        }
      } catch(e){}
    }
  };
  ws.onclose = ()=> { appendMsg('WS disconnected, reconnect in 3s'); setTimeout(initWS,3000); }
  ws.onerror = (ev) => appendMsg('WS error: '+ev);
}

function send(cmd){
  appendMsg('WS -> ' + cmd);
  if(ws && ws.readyState === WebSocket.OPEN){
    ws.send(cmd);
  } else {
    appendMsg('WS not connected');
  }
}

function appendMsg(text){
  const el = document.getElementById('msgs');
  el.innerText = `${new Date().toLocaleTimeString()}  ${text}\n` + el.innerText;
}

function showTelemetry(d){
  document.getElementById('telemetry').innerText = JSON.stringify(d, null, 2);
}

initWS();
</script>
</body>
</html>

